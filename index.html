<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Cloud Invoice Manager</title>
   <!-- Load Tailwind CSS -->
   <script src="https://cdn.tailwindcss.com"></script>
   <style>
       @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
       body { font-family: 'Inter', sans-serif; }
       input[type="number"]::-webkit-inner-spin-button,
       input[type="number"]::-webkit-outer-spin-button {
           -webkit-appearance: none;
           margin: 0;
       }
       input[type="number"] { -moz-appearance: textfield; }
       .status-paid { background-color: #d1fae5; }
       .status-overdue { background-color: #fee2e2; }
       .status-unpaid { background-color: #f0f9ff; }
       .invoice-table th, .invoice-table td { padding: 0.75rem; }
   </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">

   <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
       <h1 class="text-3xl font-bold text-indigo-700 mb-6 border-b pb-3">BAW BAW AERIAL SERVICES - Invoice Manager</h1>
       <p class="mb-6 text-gray-600">This application uses **Firebase Firestore** (a cloud database) to securely store invoices. You must be logged in to save or view data.</p>
       
       <!-- Authentication Section -->
       <div class="bg-indigo-50 p-4 rounded-lg shadow-inner mb-8 space-y-4 border border-indigo-200">
           <h3 class="text-xl font-semibold text-indigo-800">Cloud Access</h3>
           <p class="text-sm">Status: <strong id="login-status" class="font-medium text-red-600">Checking status...</strong></p>
           <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
               <input type="email" id="loginEmail" placeholder="Email (e.g., your@email.com)" class="p-2 border border-gray-300 rounded-lg flex-grow w-full sm:w-auto">
               <input type="password" id="loginPassword" placeholder="Password" class="p-2 border border-gray-300 rounded-lg flex-grow w-full sm:w-auto">
               <button onclick="loginUser()" class="bg-indigo-600 text-white p-2 rounded-lg font-medium hover:bg-indigo-700 transition">Log In</button>
               <button onclick="logoutUser()" class="bg-gray-400 text-white p-2 rounded-lg font-medium hover:bg-gray-500 transition">Log Out</button>
               <button onclick="signUpUser()" class="bg-green-600 text-white p-2 rounded-lg font-medium hover:bg-green-700 transition">Sign Up</button>
           </div>
       </div>

       <div class="grid lg:grid-cols-2 gap-10">
           <!-- Invoice Creation/Edit Form -->
           <div id="invoice-form">
               <h2 id="formTitle" class="text-2xl font-semibold text-gray-800 mb-4">Create New Invoice</h2>
               <input type="hidden" id="editInvoiceId" value="">
               
               <!-- Logo and Payee Details -->
               <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                   <h3 class="text-lg font-medium mb-3">Your Details (Payee)</h3>
                   <div class="flex items-center space-x-4 mb-4">
                       <img id="logoPreview" class="w-20 h-20 object-contain rounded-lg border p-1 bg-white" src="https://placehold.co/80x80/EEEEEE/888888?text=Logo" onerror="this.src='https://placehold.co/80x80/EEEEEE/888888?text=Logo'">
                       <label class="block">
                           <span class="sr-only">Choose logo file</span>
                           <input type="file" id="logoInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200"/>
                       </label>
                   </div>
                   <input type="text" id="payeeName" placeholder="Your Company Name" class="input-field mb-2">
                   <input type="text" id="payeeABN" placeholder="Your ABN/Tax ID" class="input-field mb-2">
                   <textarea id="payeeAddress" placeholder="Your Address" class="input-field mb-2"></textarea>
                   <input type="text" id="payeePhone" placeholder="Your Phone" class="input-field mb-2">
                   <input type="email" id="payeeEmail" placeholder="Your Email" class="input-field mb-2">
                   <input type="text" id="payeeBSB" placeholder="Bank BSB" class="input-field mb-2">
                   <input type="text" id="payeeAccount" placeholder="Bank Account Number" class="input-field">
               </div>

               <!-- Client and Invoice Details -->
               <div class="grid sm:grid-cols-2 gap-4 mb-6">
                   <input type="text" id="invoiceNumber" placeholder="Invoice #" class="input-field">
                   <select id="invoiceStatus" class="input-field">
                       <option value="Unpaid">Unpaid</option>
                       <option value="Paid">Paid</option>
                       <option value="Cancelled">Cancelled</option>
                   </select>
                   <input type="date" id="invoiceDate" placeholder="Invoice Date" class="input-field">
                   <input type="date" id="dueDate" placeholder="Due Date" class="input-field">
               </div>

               <h3 class="text-lg font-medium mb-3">Client Details (Bill To)</h3>
               <input type="text" id="clientName" placeholder="Client Name" class="input-field mb-2">
               <textarea id="clientAddress" placeholder="Client Address" placeholder="Client Address" class="input-field mb-2"></textarea>
               <input type="text" id="clientPhone" placeholder="Client Phone" class="input-field mb-2">
               <input type="email" id="clientEmail" placeholder="Client Email" class="input-field">
               
               <h3 class="text-lg font-medium mt-6 mb-3">Invoice Items</h3>
               <table class="w-full text-sm mb-4">
                   <thead>
                       <tr class="bg-gray-100 rounded-t-lg">
                           <th class="p-2 text-left w-1/2 rounded-tl-lg">Description</th>
                           <th class="p-2 text-right">Qty</th>
                           <th class="p-2 text-right">Unit Price</th>
                           <th class="p-2 text-right rounded-tr-lg">Total</th>
                           <th class="p-2"></th>
                       </tr>
                   </thead>
                   <tbody id="itemsBody"></tbody>
               </table>
               <button id="addItemBtn" class="w-full bg-blue-100 text-blue-700 p-2 rounded-lg font-medium hover:bg-blue-200 transition mb-4">+ Add Item</button>

               <!-- Running Totals Display -->
               <div class="mb-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
                   <div class="flex justify-between font-medium text-gray-700 mb-1">
                       <span>Subtotal:</span>
                       <span id="displaySubtotal">$0.00</span>
                   </div>
                   <div class="flex justify-between font-medium text-gray-700 border-b pb-2 mb-2">
                       <label class="flex items-center space-x-2 text-sm">
                           <input type="checkbox" id="includeGST" checked class="rounded text-indigo-600 focus:ring-indigo-500" onchange="updateGrandTotal()">
                           <span>GST (10%):</span>
                       </label>
                       <span id="displayGST">$0.00</span>
                   </div>
                   <div class="flex justify-between font-bold text-lg text-indigo-700">
                       <span>GRAND TOTAL:</span>
                       <span id="displayGrandTotal">$0.00</span>
                   </div>
               </div>
               
               <textarea id="notes" placeholder="Notes (e.g., Payment Terms, Disclaimers)" class="input-field mb-6 h-20"></textarea>

               <div class="flex space-x-3">
                   <button id="saveInvoiceBtn" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold text-lg hover:bg-green-700 transition">ðŸ’¾ Save Invoice to Cloud</button>
                   <button id="cancelEditBtn" class="w-auto bg-gray-300 text-gray-800 p-3 rounded-lg font-medium hover:bg-gray-400 transition" style="display:none;">New / Cancel Edit</button>
               </div>

           </div>

           <!-- Invoice List -->
           <div id="invoice-list">
               <h2 class="text-2xl font-semibold text-gray-800 mb-4">Saved Invoices</h2>

               <div class="flex flex-wrap gap-4 mb-6">
                   <div class="flex items-center space-x-2">
                       <label for="filterStatus" class="text-sm font-medium text-gray-700">Status:</label>
                       <select id="filterStatus" class="p-2 border rounded-lg" onchange="loadInvoicesAndRender()">
                           <option value="All">All</option>
                           <option value="Unpaid">Unpaid</option>
                           <option value="Paid">Paid</option>
                           <option value="Overdue">Overdue</option>
                           <option value="Cancelled">Cancelled</option>
                       </select>
                   </div>
                   <div class="flex items-center space-x-2">
                       <label for="filterYear" class="text-sm font-medium text-gray-700">Financial Year:</label>
                       <select id="filterYear" class="p-2 border rounded-lg" onchange="loadInvoicesAndRender()">
                           <!-- Options populated by JS -->
                       </select>
                   </div>
               </div>

               <!-- Invoice Summary Block -->
               <div id="invoice-summary" class="bg-white border rounded-lg shadow-md p-4 mb-6 grid grid-cols-2 gap-4">
                   <div class="p-3 bg-blue-50 rounded-lg">
                       <p class="text-xs font-medium text-blue-600 uppercase">Total Invoiced Value</p>
                       <p id="summaryTotalAll" class="text-xl font-bold text-gray-800">$0.00</p>
                   </div>
                   <div class="p-3 bg-red-50 rounded-lg">
                       <p class="text-xs font-medium text-red-600 uppercase">Total Still Unpaid</p>
                       <p id="summaryTotalUnpaid" class="text-xl font-bold text-gray-800">$0.00</p>
                   </div>
               </div>

               <div class="overflow-x-auto rounded-lg border">
                   <table class="invoice-table w-full text-sm">
                       <thead>
                           <tr class="bg-gray-100">
                               <th class="text-left">#</th>
                               <th class="text-left">Client</th>
                               <th class="text-left">Date</th>
                               <th class="text-left">Due</th>
                               <th class="text-left">Status</th>
                               <th class="text-left">Actions</th>
                           </tr>
                       </thead>
                       <tbody id="invoiceTableBody">
                           <tr><td colspan="6" class="text-center p-4 text-gray-500">Please log in to load invoices.</td></tr>
                       </tbody>
                   </table>
               </div>
           </div>
       </div>
   </div>

   <!-- Reusable styles for inputs -->
   <style>
       .input-field {
           @apply w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150;
       }
   </style>

   <script type="module">
       // =========================================================================
       // FIREBASE V9 MODULAR SDK IMPORTS
       // =========================================================================
       import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
       import {
         getAuth,
         createUserWithEmailAndPassword,
         signInWithEmailAndPassword,
         signOut,
         onAuthStateChanged
       } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
       import {
         getFirestore,
         collection,
         query,
         where,
         getDocs,
         addDoc,
         updateDoc,
         setDoc, // Added setDoc for potential future use or consistency
         deleteDoc,
         serverTimestamp,
         doc
       } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

       // =========================================================================
       // USER'S FIREBASE CONFIGURATION (Provided by user)
       // =========================================================================
       const firebaseConfig = {
         apiKey: "AIzaSyDFk7MaEfHd7ApFYS7TztSFphtspT4-axo",
         authDomain: "invoicemanager-b0604.firebaseapp.com",
         projectId: "invoicemanager-b0604",
         storageBucket: "invoicemanager-b0604.firebasestorage.app",
         messagingSenderId: "47773331214",
         appId: "1:47773331214:web:6d9066b2e6b1f29cb3715f",
         measurementId: "G-0GWKMR09EN"
       };
       
       // Initialize Firebase services
       const app = initializeApp(firebaseConfig);
       const auth = getAuth(app);
       const db = getFirestore(app);
       let userId = null;
       let invoices = [];

       // DOM Elements
       const itemsBody = document.getElementById('itemsBody');
       const logoPreview = document.getElementById('logoPreview');
       const invoiceTableBody = document.getElementById('invoiceTableBody');
       const loginStatus = document.getElementById('login-status');
       const loginEmailInput = document.getElementById('loginEmail');
       const loginPasswordInput = document.getElementById('loginPassword');
       
       const displaySubtotal = document.getElementById('displaySubtotal');
       const displayGST = document.getElementById('displayGST');
       const displayGrandTotal = document.getElementById('displayGrandTotal');
       const filterYear = document.getElementById('filterYear');
       const saveInvoiceBtn = document.getElementById('saveInvoiceBtn');
       const cancelEditBtn = document.getElementById('cancelEditBtn');
       const formTitle = document.getElementById('formTitle');
       const editInvoiceIdInput = document.getElementById('editInvoiceId');

       const summaryTotalAll = document.getElementById('summaryTotalAll');
       const summaryTotalUnpaid = document.getElementById('summaryTotalUnpaid');

       // --- State and helpers (Logo and Payee still use Local Storage for simplicity) ---
       let logoDataURL = localStorage.getItem('invoiceLogo')||'';
       
       // --- Set initial date values for better UX ---
       const today = new Date().toISOString().split('T')[0];
       const dueDateDefault = new Date();
       dueDateDefault.setDate(dueDateDefault.getDate() + 14);
       const dueDateValue = dueDateDefault.toISOString().split('T')[0];
       
       // --- Utility Functions ---
       function formatCurrency(n){ return '$' + Number(n||0).toFixed(2); }
       function escapeHtml(str){ if(!str) return ''; return String(str).replace(/&/g,'&').replace(/</g,'<').replace(/>/g,'>').replace(/"/g,'"'); }
       function generateInvoiceNumber(){ let last = parseInt(localStorage.getItem('lastInvoiceNumber')||'1000',10); last++; localStorage.setItem('lastInvoiceNumber',String(last)); return String(last); }

       /**
        * Determines the Australian financial year (Jul 1 - Jun 30) for a given date.
        */
       function getFinancialYear(dateString) {
           if (!dateString) return 'N/A';
           const date = new Date(dateString + 'T00:00:00');
           const year = date.getFullYear();
           const month = date.getMonth(); // 0 = Jan, 6 = Jul
           
           // If month is July (6) or later, it's the current year to next year.
           if (month >= 6) {
               return `${year}-${year + 1}`;
           } else {
               return `${year - 1}-${year}`;
           }
       }
       
       function savePayeeToStorage(){
         ['payeeName','payeeABN','payeeAddress','payeePhone','payeeEmail','payeeBSB','payeeAccount'].forEach(id=>{
           localStorage.setItem(id, document.getElementById(id).value);
         });
       }
       function loadPayeeFromStorage(){
         ['payeeName','payeeABN','payeeAddress','payeePhone','payeeEmail','payeeBSB','payeeAccount'].forEach(id=>{
           const el = document.getElementById(id);
           el.value = localStorage.getItem(id)||el.value;
           el.addEventListener('change', savePayeeToStorage);
         });
       }

       // --- Logo upload ---
       document.getElementById('logoInput').addEventListener('change', e=>{
         const f = e.target.files && e.target.files[0];
         if(!f) return;
         const r = new FileReader();
         r.onload = ev => {
           logoDataURL = ev.target.result;
           logoPreview.src = logoDataURL;
           localStorage.setItem('invoiceLogo', logoDataURL);
         };
         r.readAsDataURL(f);
       });

       // --- Grand Total Calculation ---
       function calculateCurrentItemsTotal() {
           let currentSubtotal = 0;
           Array.from(itemsBody.querySelectorAll('tr')).forEach(r => {
               const qtyInput = r.querySelector('.it-qty');
               const unitInput = r.querySelector('.it-unit');
               const q = parseFloat(qtyInput.value || 0);
               const u = parseFloat(unitInput.value || 0);
               currentSubtotal += q * u;
           });
           return currentSubtotal;
       }

       window.updateGrandTotal = function() {
           const subtotal = calculateCurrentItemsTotal();
           const includeGST = document.getElementById('includeGST').checked;
           const gst = includeGST ? subtotal * 0.10 : 0;
           const grandTotal = subtotal + gst;

           displaySubtotal.textContent = formatCurrency(subtotal);
           displayGST.textContent = formatCurrency(gst);
           displayGrandTotal.textContent = formatCurrency(grandTotal);
       }

       // --- Items ---
       function addItemRow(desc='', qty=1, unit=0){
         const tr = document.createElement('tr');
         tr.className = "border-t border-gray-200";
         tr.innerHTML = `
           <td class="p-2"><input class="it-desc w-full" value="${escapeHtml(desc)}" placeholder="Description" oninput="updateTotalRow(this.closest('tr'))"></td>
           <td class="p-2"><input class="it-qty w-full text-right" type="number" min="0" value="${qty}" oninput="updateTotalRow(this.closest('tr'))"></td>
           <td class="p-2"><input class="it-unit w-full text-right" type="number" min="0" step="0.01" value="${unit}" oninput="updateTotalRow(this.closest('tr'))"></td>
           <td class="it-total p-2 text-right font-medium">${formatCurrency(qty*unit)}</td>
           <td class="p-2"><button type="button" class="remove text-red-500 hover:text-red-700 transition font-medium">X</button></td>`;
         itemsBody.appendChild(tr);

         tr.querySelector('.remove').addEventListener('click', ()=>{ tr.remove(); updateGrandTotal(); });
         
         // Add input change listeners to trigger total update
         tr.querySelectorAll('input').forEach(input => input.addEventListener('input', updateGrandTotal));

         updateGrandTotal();
       }

       window.updateTotalRow = function(tr) {
           const qtyInput = tr.querySelector('.it-qty');
           const unitInput = tr.querySelector('.it-unit');
           const q = parseFloat(qtyInput.value || 0);
           const u = parseFloat(unitInput.value || 0);
           tr.querySelector('.it-total').textContent = formatCurrency(q * u);
           updateGrandTotal(); // Call to update the running grand total
       }

       document.getElementById('addItemBtn').addEventListener('click', ()=>addItemRow());
       document.getElementById('includeGST').addEventListener('change', updateGrandTotal);

       // --- Reset Form Function ---
       function resetFormForNewInvoice() {
           // Reset main fields
           document.getElementById('clientName').value='';
           document.getElementById('clientPhone').value='';
           document.getElementById('clientEmail').value='';
           document.getElementById('clientAddress').value='';
           document.getElementById('invoiceNumber').value=generateInvoiceNumber();
           document.getElementById('invoiceDate').value=today;
           document.getElementById('dueDate').value=dueDateValue;
           document.getElementById('notes').value='';
           document.getElementById('includeGST').checked = true;
           document.getElementById('invoiceStatus').value = 'Unpaid';
           
           // Clear items and add one default row
           itemsBody.innerHTML=''; addItemRow();
           
           // Reset Edit state indicators
           editInvoiceIdInput.value = '';
           formTitle.textContent = 'Create New Invoice';
           saveInvoiceBtn.textContent = 'ðŸ’¾ Save Invoice to Cloud';
           saveInvoiceBtn.classList.replace('bg-indigo-600', 'bg-green-600');
           cancelEditBtn.style.display = 'none';

           updateGrandTotal();
       }
       cancelEditBtn.addEventListener('click', resetFormForNewInvoice);


       // --- Save/Update invoice (ASYNC CLOUD FUNCTION) ---
       async function saveInvoice(){
         if(!userId){ alert('Please log in first to save invoices.'); return; }

         const invoiceIdToEdit = editInvoiceIdInput.value;
         
         // 1. Collect Items and Calculate Totals
         const items = Array.from(itemsBody.querySelectorAll('tr')).map(r=>{
           const desc = r.querySelector('.it-desc').value || '';
           const qty = parseFloat(r.querySelector('.it-qty').value)||0;
           const unit = parseFloat(r.querySelector('.it-unit').value)||0;
           return {description:desc, qty, unit};
         }).filter(it => it.description || it.qty || it.unit);

         const subtotal = calculateCurrentItemsTotal();
         const includeGST = document.getElementById('includeGST').checked;
         const gst = includeGST ? subtotal * 0.10 : 0;
         const total = subtotal + gst;

         // 2. Create Invoice Object (excluding dynamic payee data for update, as it's saved locally)
         const invData = {
           clientName: document.getElementById('clientName').value || '',
           clientPhone: document.getElementById('clientPhone').value || '',
           clientEmail: document.getElementById('clientEmail').value || '',
           clientAddress: document.getElementById('clientAddress').value || '',
           payeeName: document.getElementById('payeeName').value || '',
           payeeABN: document.getElementById('payeeABN').value || '',
           payeeAddress: document.getElementById('payeeAddress').value || '',
           payeePhone: document.getElementById('payeePhone').value || '',
           payeeEmail: document.getElementById('payeeEmail').value || '',
           payeeBSB: document.getElementById('payeeBSB').value || '',
           payeeAccount: document.getElementById('payeeAccount').value || '',
           invoiceNumber: document.getElementById('invoiceNumber').value || (invoiceIdToEdit ? invData.invoiceNumber : generateInvoiceNumber()),
           invoiceDate: document.getElementById('invoiceDate').value || today,
           dueDate: document.getElementById('dueDate').value || '',
           status: document.getElementById('invoiceStatus').value || 'Unpaid',
           includeGST: includeGST,
           notes: document.getElementById('notes').value || '',
           logo: logoDataURL,
           items: items,
           subtotal: subtotal,
           total: total,
           userId: userId,
         };

         if(!invData.clientName || !invData.invoiceNumber || !invData.invoiceDate){
           alert('Please fill Client name, Invoice number and Invoice date');
           return;
         }
         
         try {
           if (invoiceIdToEdit) {
               // --- UPDATE EXISTING INVOICE ---
               const invoiceRef = doc(db, 'invoices', invoiceIdToEdit);
               // Don't update the creation timestamp
               await updateDoc(invoiceRef, invData);
               alert(`Invoice #${invData.invoiceNumber} updated successfully!`);
               
           } else {
               // --- CREATE NEW INVOICE ---

               // 3. Check for unique invoice number for the user (only for new creation)
               const q = query(collection(db, 'invoices'),
                 where('invoiceNumber', '==', invData.invoiceNumber),
                 where('userId', '==', userId)
               );
               const existing = await getDocs(q);

               if(existing.docs.length > 0){
                   alert(`Invoice number ${invData.invoiceNumber} already exists for your user account.`);
                   return;
               }
               
               // Add creation timestamp only when creating
               invData.createdAt = serverTimestamp();
               
               // 4. Save to Firestore
               await addDoc(collection(db, 'invoices'), invData);
               alert('Invoice saved successfully to the cloud!');
           }
           
           // 5. Reset form and reload list
           resetFormForNewInvoice();
           await loadInvoicesAndRender();

         } catch(e){
           console.error(invoiceIdToEdit ? "Error updating document: " : "Error saving document: ", e);
           alert(`Failed to ${invoiceIdToEdit ? 'update' : 'save'} invoice. Check console for details.`);
         }
       }

       document.getElementById('saveInvoiceBtn').addEventListener('click', saveInvoice);

       // --- Edit Invoice Function ---
       window.editInvoice = function(id) {
           const inv = invoices.find(i => i.id === id);
           if (!inv) { alert('Invoice not found for editing.'); return; }
           
           // Set Edit state indicators
           editInvoiceIdInput.value = inv.id;
           formTitle.textContent = `Editing Invoice #${inv.invoiceNumber}`;
           saveInvoiceBtn.textContent = 'âœ… Update Invoice';
           saveInvoiceBtn.classList.replace('bg-green-600', 'bg-indigo-600');
           cancelEditBtn.style.display = 'inline-block';

           // Populate fields
           document.getElementById('clientName').value = inv.clientName || '';
           document.getElementById('clientPhone').value = inv.clientPhone || '';
           document.getElementById('clientEmail').value = inv.clientEmail || '';
           document.getElementById('clientAddress').value = inv.clientAddress || '';
           
           document.getElementById('invoiceNumber').value = inv.invoiceNumber || '';
           document.getElementById('invoiceDate').value = inv.invoiceDate || today;
           document.getElementById('dueDate').value = inv.dueDate || dueDateValue;
           document.getElementById('invoiceStatus').value = inv.status || 'Unpaid';
           document.getElementById('includeGST').checked = inv.includeGST !== undefined ? inv.includeGST : true;
           document.getElementById('notes').value = inv.notes || '';

           // Handle Logo update (update local state/preview only)
           if (inv.logo) {
               logoDataURL = inv.logo;
               logoPreview.src = inv.logo;
           }

           // Populate items table
           itemsBody.innerHTML = '';
           if (inv.items && inv.items.length > 0) {
               inv.items.forEach(item => addItemRow(item.description, item.qty, item.unit));
           } else {
               addItemRow();
           }

           // Scroll to the top of the form
           document.getElementById('invoice-form').scrollIntoView({ behavior: 'smooth' });
       }


       // --- Invoice list rendering (ASYNC CLOUD FUNCTION) ---
       async function loadInvoicesAndRender(){
         if(!userId) {
           invoiceTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 p-4">Please log in to view and save invoices.</td></tr>';
           summaryTotalAll.textContent = formatCurrency(0);
           summaryTotalUnpaid.textContent = formatCurrency(0);
           loginStatus.textContent = 'Logged out';
           loginStatus.classList.replace('text-green-600', 'text-red-600');
           return;
         }
         loginStatus.textContent = `Logged in as ${auth.currentUser.email}`;
         loginStatus.classList.replace('text-red-600', 'text-green-600');

         invoiceTableBody.innerHTML='<tr><td colspan="6" class="text-center text-gray-500 p-4">Loading invoices...</td></tr>';
         
         try {
           const filterStatus = document.getElementById('filterStatus').value;
           const filterYearValue = document.getElementById('filterYear').value;
           const todayForCheck = new Date().toISOString().split('T')[0];
           
           // 1. Build Query (filter by user ID is CRITICAL)
           let q = query(collection(db, 'invoices'),
                       where('userId', '==', userId)
                   );
           
           const snapshot = await getDocs(q);
           
           // 2. Map documents to array, including the Firestore document ID
           invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
           
           // 3. Sort client-side by creation date (newest first)
           invoices.sort((a, b) => {
               const aTime = b.createdAt ? b.createdAt.seconds : 0;
               const bTime = a.createdAt ? a.createdAt.seconds : 0;
               return bTime - aTime; // Sort descending (newest first)
           });

           // 4. Apply Filters and calculate Overdue status
           let totalAll = 0;
           let totalUnpaid = 0;

           let filteredInvoices = invoices.filter(inv => {
               // Determine overdue status
               if(inv.status !== 'Paid' && inv.dueDate && inv.dueDate < todayForCheck) {
                   inv.status = 'Overdue';
               }

               // Check Financial Year filter
               const isCorrectYear = filterYearValue === 'All' || getFinancialYear(inv.invoiceDate) === filterYearValue;

               // Check Status filter
               const isCorrectStatus = filterStatus === 'All' || inv.status === filterStatus;

               // Calculate Totals based only on year filter
               if (isCorrectYear) {
                   totalAll += inv.total || 0; // Use the saved total
                   if (inv.status !== 'Paid' && inv.status !== 'Cancelled') {
                       totalUnpaid += inv.total || 0;
                   }
               }

               return isCorrectYear && isCorrectStatus;
           });

           // 5. Update Summary Display
           summaryTotalAll.textContent = formatCurrency(totalAll);
           summaryTotalUnpaid.textContent = formatCurrency(totalUnpaid);
           
           // 6. Render Table
           invoiceTableBody.innerHTML='';
           
           if(filteredInvoices.length === 0){
               invoiceTableBody.innerHTML=`<tr><td colspan="6" class="text-center text-gray-500 p-4">No matching invoices found.</td></tr>`;
           }

           filteredInvoices.forEach((inv)=>{
               const tr = document.createElement('tr');
               tr.className = `border-t border-gray-200 ${inv.status === 'Paid' ? 'status-paid' : inv.status === 'Overdue' ? 'status-overdue' : 'status-unpaid'}`;
               tr.innerHTML = `
                 <td class="p-3">${escapeHtml(inv.invoiceNumber)}</td>
                 <td class="p-3">${escapeHtml(inv.clientName)}</td>
                 <td class="p-3">${escapeHtml(inv.invoiceDate)}</td>
                 <td class="p-3">${escapeHtml(inv.dueDate||'')}</td>
                 <td class="p-3 font-medium">${escapeHtml(inv.status)}</td>
                 <td class="p-3 space-x-1">
                   <button data-id="${inv.id}" class="openBtn bg-indigo-500 text-white text-xs p-1 rounded hover:bg-indigo-600">Open</button>
                   <button data-id="${inv.id}" class="editBtn bg-blue-500 text-white text-xs p-1 rounded hover:bg-blue-600">Edit</button>
                   <button data-id="${inv.id}" class="payBtn bg-yellow-500 text-white text-xs p-1 rounded hover:bg-yellow-600">Paid</button>
                   <button data-id="${inv.id}" class="delBtn bg-red-500 text-white text-xs p-1 rounded hover:bg-red-600">Delete</button>
                 </td>`;
               invoiceTableBody.appendChild(tr);
           });

           // 7. Attach event listeners
           document.querySelectorAll('.openBtn').forEach(b=>b.addEventListener('click', e=>openInvoice(e.currentTarget.dataset.id)));
           document.querySelectorAll('.editBtn').forEach(b=>b.addEventListener('click', e=>editInvoice(e.currentTarget.dataset.id)));
           document.querySelectorAll('.payBtn').forEach(b=>b.addEventListener('click', e=>updateInvoiceStatus(e.currentTarget.dataset.id, 'Paid')));
           document.querySelectorAll('.delBtn').forEach(b=>b.addEventListener('click', e=>{
               // NOTE: Using window.confirm() here as a quick UI solution, but ideally this would be a custom modal/dialog.
               if(window.confirm('Are you sure you want to permanently delete this invoice?')){ deleteInvoice(e.currentTarget.dataset.id); }
           }));

         } catch(e) {
           console.error("Error loading documents: ", e);
           invoiceTableBody.innerHTML='<tr><td colspan="6" class="text-center text-red-500 p-4">ERROR loading invoices. Check Firebase rules.</td></tr>';
         }
       }

       // --- Cloud Actions (Update/Delete) ---
       async function updateInvoiceStatus(id, newStatus){
         try {
           const invoiceRef = doc(db, 'invoices', id);
           await updateDoc(invoiceRef, { status: newStatus });
           alert(`Invoice status set to ${newStatus} successfully!`);
           await loadInvoicesAndRender();
         } catch(e) {
           console.error("Error updating document: ", e);
           alert('Failed to update status. Please check the console for details, and ensure your Firebase Security Rules allow updates.');
         }
       }

       async function deleteInvoice(id){
         try {
           const invoiceRef = doc(db, 'invoices', id);
           await deleteDoc(invoiceRef);
           alert('Invoice deleted successfully!');
           await loadInvoicesAndRender();
         } catch(e) {
           console.error("Error deleting document: ", e);
           alert('Failed to delete invoice. Please check the console for details, and ensure your Firebase Security Rules allow deletions.');
         }
       }

       // --- Open invoice (New tab - same logic) ---
       window.openInvoice = function(id){
         const inv = invoices.find(i => i.id === id);
         if (!inv) return;
         
         const subtotal = inv.subtotal || inv.items.reduce((s,it)=>s + (it.qty*it.unit),0);
         const gst = inv.includeGST ? subtotal * 0.10 : 0;
         const total = inv.total || (subtotal + gst);

         const itemsHtml = inv.items.map(it=>`<tr><td>${escapeHtml(it.description)}</td><td style="text-align:right">${it.qty}</td><td style="text-align:right">${formatCurrency(it.unit)}</td><td style="text-align:right">${formatCurrency(it.qty*it.unit)}</td></tr>`).join('');

         // Basic HTML for printable invoice view
         const html = `<!doctype html><html><head><meta charset="utf-8"><title>Invoice ${escapeHtml(inv.invoiceNumber)}</title><style>body{font-family:Arial;padding:40px} .row{display:flex;justify-content:space-between} table{width:100%;border-collapse:collapse;margin-top:20px} th,td{border:1px solid #ccc;padding:8px} th{background:#f0f0f0} .msg{background:#f4f4f4;padding:16px;margin-top:20px} .totals{margin-top:20px;text-align:right} .disclaimer{margin-top:30px;font-size:13px;color:#444;background:#fafafa;padding:12px}</style></head><body>`
           + `<div class="row"><div>`
           + (inv.logo?`<img src="${escapeHtml(inv.logo)}" style="max-width:220px;display:block;margin-bottom:10px">`:'')
           + `<strong>${escapeHtml(inv.payeeName||'')}</strong><br>ABN: ${escapeHtml(inv.payeeABN||'')}<br>${escapeHtml(inv.payeeAddress||'')}<br>Phone: ${escapeHtml(inv.payeePhone||'')}<br>Email: ${escapeHtml(inv.payeeEmail||'')}</div>`
           + `<div style="text-align:right"><h2>TAX INVOICE</h2><div><strong>Date:</strong> ${escapeHtml(inv.invoiceDate)}<br><strong>Invoice #:</strong> ${escapeHtml(inv.invoiceNumber)}<br><strong>Status:</strong> <span style="font-weight:bold; color:${inv.status==='Paid'?'green':'red'}">${escapeHtml(inv.status)}</span><br><strong>Pay To:</strong> ${escapeHtml(inv.payeeName||'')}<br><strong>BSB:</strong> ${escapeHtml(inv.payeeBSB||'')}<br><strong>Account:</strong> ${escapeHtml(inv.payeeAccount||'')}</div></div></div>`
           + `<h3>Bill To</h3><div>${escapeHtml(inv.clientName)}<br>${escapeHtml(inv.clientAddress)}<br>${escapeHtml(inv.clientPhone)}<br>${escapeHtml(inv.clientEmail)}</div>`
           + `<table><thead><tr><th>Description</th><th style="text-align:right">Qty/Hrs</th><th style="text-align:right">Unit Price</th><th style="text-align:right">Total</th></tr></thead><tbody>${itemsHtml}</tbody></table>`
           + `<div class="totals"><div>Subtotal: ${formatCurrency(subtotal)}</div>`
           + (inv.includeGST ? `<div>GST (10%): ${formatCurrency(gst)}</div>` : '')
           + `<div style="font-weight:bold; font-size:1.2em;">Total: ${formatCurrency(total)}</div></div>`
           + `<div class="msg"><strong>Notes:</strong> ${escapeHtml(inv.notes)}</div>`
           + `<div class="disclaimer">All services must be paid within 14 days. A late fee may apply.</div>`
           + `<div style="margin-top:30px"></div></body></html>`;

         const w = window.open();
         w.document.write(html);
         w.document.close();
       }

       // --- Filter Setup ---
       function populateFinancialYearFilter() {
           const currentYear = new Date().getFullYear();
           const yearOptions = ['All'];
           
           // Generate last 5 years + current year + next year
           for(let i = currentYear - 5; i <= currentYear + 1; i++){
               yearOptions.push(`${i}-${i + 1}`);
           }

           filterYear.innerHTML = yearOptions.map(y =>
               `<option value="${y}" ${y === 'All' ? 'selected' : ''}>${y}</option>`
           ).join('');
       }


       // =========================================================================
       // AUTHENTICATION FUNCTIONS (Exposed globally for HTML onclick)
       // =========================================================================

       window.signUpUser = function() {
         const email = loginEmailInput.value;
         const password = loginPasswordInput.value;

         if (!email || !password) { alert('Please enter an email and password to sign up.'); return; }
         
         createUserWithEmailAndPassword(auth, email, password)
           .then((userCredential) => {
             alert("Sign Up Successful! You are now logged in.");
           })
           .catch((error) => {
             console.error("Sign Up Error:", error);
             alert('Sign Up Error: ' + error.message);
           });
       }

       window.loginUser = function() {
         const email = loginEmailInput.value;
         const password = loginPasswordInput.value;

         if (!email || !password) { alert('Please enter an email and password to log in.'); return; }

         signInWithEmailAndPassword(auth, email, password)
           .then((userCredential) => {
             alert("Logged in successfully!");
           })
           .catch((error) => {
             console.error("Login Error:", error);
             alert('Login Error: ' + error.message);
           });
       }

       window.logoutUser = function() {
         signOut(auth).then(() => {
           alert("Logged out successfully.");
         }).catch((error) => {
           console.error("Logout Error:", error);
           alert('Logout Error: ' + error.message);
         });
       }
       
       // =========================================================================
       // INITIALIZATION
       // =========================================================================

       // Attach listener to check auth status on load
       onAuthStateChanged(auth, async (user) => {
         if (user) {
           userId = user.uid;
           loginStatus.textContent = `Logged in as ${user.email}`;
           loginStatus.classList.replace('text-red-600', 'text-green-600');
           await loadInvoicesAndRender();
         } else {
           userId = null;
           await loadInvoicesAndRender();
         }
       });

       (function init(){
         loadPayeeFromStorage();
         if(logoDataURL) logoPreview.src = logoDataURL;
         // Set initial invoice number and dates
         document.getElementById('invoiceNumber').value = generateInvoiceNumber();
         document.getElementById('invoiceDate').value = today;
         document.getElementById('dueDate').value = dueDateValue;
         
         if(itemsBody.children.length===0) addItemRow();
         document.getElementById('clientName').focus();
         populateFinancialYearFilter();
       })();

   </script>
</body>
</html>
