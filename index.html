<script type="module">

/* ------------------------- FIREBASE IMPORTS ------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, 
  doc, updateDoc, getDoc 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* ------------------------- FIREBASE CONFIG ------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDdem4YB76fD0oPrTfKMoozEJGSFi9a7ms",
  authDomain: "invoicemanager205.firebaseapp.com",
  projectId: "invoicemanager205"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

console.log("Firebase connected (NO STORAGE USED)");

/* ------------------------- ITEM ADDING ------------------------- */

function addItem() {
    const row = document.createElement("tr");
    row.innerHTML = `
       <td><input class="desc" style="width:100%"></td>
       <td><input class="qty" type="number" step="1" style="width:80px"></td>
       <td><input class="unit" type="number" step="0.01" style="width:100px"></td>
       <td><button onclick="this.parentNode.parentNode.remove()">X</button></td>
    `;
    document.getElementById("itemRows").appendChild(row);
}

/* ------------------------- LOGO (LOCALSTORAGE FIXED) ------------------------- */

let logoBase64 = localStorage.getItem("invoiceLogo") || "";

// Load saved logo back into input preview (optional)

document.getElementById("logoInput").addEventListener("change", function(e){
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = () => {
        logoBase64 = reader.result;
        localStorage.setItem("invoiceLogo", logoBase64);
    };
    reader.readAsDataURL(file);
});

/* ------------------------- SAVE INVOICE ------------------------- */

async function saveInvoice() {

    let items = [];
    document.querySelectorAll("#itemRows tr").forEach(row=>{
        const desc = row.querySelector(".desc").value;
        const qty = Number(row.querySelector(".qty").value);
        const unit = Number(row.querySelector(".unit").value);
        if(desc) items.push({ description: desc, qty, unit });
    });

    const inv = {
        invoiceNumber: invNum.value,
        invoiceDate: invDate.value,
        dueDate: invDue.value,
        clientName: clientName.value,
        clientAddress: clientAddress.value,
        clientPhone: clientPhone.value,
        clientEmail: clientEmail.value,
        items,
        gst: gstToggle.checked,
        notes: notes.value,
        logo: logoBase64,  // â† LOCALSTORAGE LOGO
        status: "Unpaid",
        created: Date.now()
    };

    await addDoc(collection(db,"invoices"), inv);
    alert("Invoice Saved!");
    loadInvoices();
}

/* ------------------------- LOAD INVOICES ------------------------- */

async function loadInvoices() {
    const snap = await getDocs(collection(db,"invoices"));
    const table = document.getElementById("invoiceTable");
    table.innerHTML = "";

    snap.forEach(docSnap => {
        const d = docSnap.data();

        const subtotal = d.items.reduce((s,it)=> s + it.qty * it.unit, 0);
        const gst = d.gst ? subtotal * 0.1 : 0;
        const total = subtotal + gst;

        let cls = "";
        if(d.status === "Paid") cls = "paid";
        else if(new Date(d.dueDate) < new Date() && d.status !== "Paid") cls = "overdue";
        else cls = "unpaid";

        table.innerHTML += `
          <tr class="${cls}">
            <td>${d.invoiceNumber}</td>
            <td>${d.invoiceDate}</td>
            <td>${d.status}</td>
            <td>${total.toFixed(2)}</td>
            <td>
                <button onclick="openInvoice('${docSnap.id}')">Open</button>
                <button onclick="markPaid('${docSnap.id}')">Paid</button>
            </td>
          </tr>
        `;
    });
}

loadInvoices();

/* ------------------------- MARK AS PAID ------------------------- */

async function markPaid(id){
    await updateDoc(doc(db,"invoices",id), { status: "Paid" });
    loadInvoices();
}

/* ------------------------- OPEN INVOICE ------------------------- */

async function openInvoice(id){
    const docSnap = await getDoc(doc(db,"invoices",id));
    if(!docSnap.exists()) return alert("Invoice not found");
    const inv = docSnap.data();

    const subtotal = inv.items.reduce((s,it)=> s + it.qty * it.unit, 0);
    const gstAmount = inv.gst ? subtotal * 0.1 : 0;
    const total = subtotal + gstAmount;

    const itemsHtml = inv.items.map(it => `
        <tr>
          <td>${it.description}</td>
          <td>${it.qty}</td>
          <td>${it.unit.toFixed(2)}</td>
          <td>${(it.qty * it.unit).toFixed(2)}</td>
        </tr>
    `).join("");

    const html = `
    <html><head><title>Invoice ${inv.invoiceNumber}</title>
    <style>
        body { font-family: Arial; padding: 40px; }
        table { width: 100%; border-collapse: collapse; margin-top:20px; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        th { background:#f0f0f0; }
    </style>
    </head><body>

    ${inv.logo ? `<img src="${inv.logo}" style="max-width:200px;">` : ""}
    <h2>Invoice ${inv.invoiceNumber}</h2>

    <p><strong>Date:</strong> ${inv.invoiceDate}</p>
    <p><strong>Due:</strong> ${inv.dueDate}</p>

    <h3>Bill To</h3>
    <p>
        ${inv.clientName}<br>
        ${inv.clientAddress}<br>
        ${inv.clientPhone}<br>
        ${inv.clientEmail}
    </p>

    <h3>Items</h3>
    <table>
       <thead><tr><th>Description</th><th>Qty</th><th>Unit</th><th>Total</th></tr></thead>
       <tbody>${itemsHtml}</tbody>
    </table>

    <p>Subtotal: ${subtotal.toFixed(2)}</p>
    <p>GST: ${gstAmount.toFixed(2)}</p>
    <p><b>Total: ${total.toFixed(2)}</b></p>

    <p>${inv.notes}</p>

    </body></html>`;

    const w = window.open();
    w.document.write(html);
    w.document.close();
}

window.openInvoice = openInvoice;
window.markPaid = markPaid;
window.addItem = addItem;

</script>
