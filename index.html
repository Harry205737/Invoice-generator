<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Invoice App</title>
</head>
<body>
  <h1>Invoice Creator</h1>

  <h2>Create Invoice</h2>
  <div>
    <label>Invoice # <input id="invNum" /></label><br>
    <label>Client <input id="client" /></label><br>
    <label>Date <input type="date" id="date" /></label><br>
    <label>Due <input type="date" id="due" /></label><br>

    <h3>Items</h3>
    <table id="items" border="1" cellpadding="4">
      <thead>
        <tr><th>Description</th><th>Qty</th><th>Price</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addItem()">Add Item</button>

    <p>Subtotal: <span id="subtotal">0.00</span></p>
    <p>Tax (10%): <span id="tax">0.00</span></p>
    <p>Total: <span id="total">0.00</span></p>

    <button onclick="saveInvoice()">Save Invoice</button>
  </div>

  <h2>Invoices</h2>
  <table id="invoiceList" border="1" cellpadding="4">
    <thead>
      <tr>
        <th>#</th><th>Client</th><th>Date</th><th>Due</th><th>Status</th><th>Total</th><th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
let invoices = JSON.parse(localStorage.getItem("invoices")||"[]");

function addItem(){
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input oninput="calc()" /></td>
    <td><input type="number" value="1" oninput="calc()" /></td>
    <td><input type="number" value="0" oninput="calc()" /></td>
    <td><button onclick="this.parentElement.parentElement.remove(); calc();">X</button></td>`;
  document.querySelector('#items tbody').appendChild(row);
  calc();
}

function calc(){
  let subtotal = 0;
  document.querySelectorAll('#items tbody tr').forEach(r=>{
    const qty = parseFloat(r.children[1].children[0].value)||0;
    const price = parseFloat(r.children[2].children[0].value)||0;
    subtotal += qty*price;
  });
  const tax = subtotal*0.10;
  const total = subtotal+tax;
  document.getElementById('subtotal').textContent=subtotal.toFixed(2);
  document.getElementById('tax').textContent=tax.toFixed(2);
  document.getElementById('total').textContent=total.toFixed(2);
}

function saveInvoice(){
  const inv = {
    num: document.getElementById('invNum').value,
    client: document.getElementById('client').value,
    date: document.getElementById('date').value,
    due: document.getElementById('due').value,
    subtotal: parseFloat(document.getElementById('subtotal').textContent),
    tax: parseFloat(document.getElementById('tax').textContent),
    total: parseFloat(document.getElementById('total').textContent),
    paid: false
  };
  invoices.push(inv);
  localStorage.setItem("invoices",JSON.stringify(invoices));
  listInvoices();
  alert("Saved");
}

function listInvoices(){
  const tbody = document.querySelector('#invoiceList tbody');
  tbody.innerHTML="";
  invoices.forEach((inv,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${inv.num}</td>
      <td>${inv.client}</td>
      <td>${inv.date}</td>
      <td>${inv.due}</td>
      <td>${inv.paid?"Paid":"Unpaid"}</td>
      <td>${inv.total.toFixed(2)}</td>
      <td>
        <button onclick=\"printInvoice(i)\">Print</button>
        <button onclick=\"togglePaid(i)\">Toggle Paid</button(${i})">Toggle Paid</button>
        <button onclick="delInv(${i})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function togglePaid(i){
  invoices[i].paid = !invoices[i].paid;
  localStorage.setItem("invoices",JSON.stringify(invoices));
  listInvoices();
}

function delInv(i){
  invoices.splice(i,1);
  localStorage.setItem("invoices",JSON.stringify(invoices));
  listInvoices();
}

listInvoices();
function printInvoice(i){
  const inv=invoices[i];
  const itemsHTML = document.querySelectorAll('#items tbody tr').length? '' : '';
  const logo='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABQAAAAHgCAYAAAD678BmAAAABHNCSVQICAgIfAhkiAAAIABJREFUeJzs3XecXFX9PvDnnFumz872...';
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><body>
    <div><img src="${logo}" style="max-width:300px;"></div>
    <h1>Invoice #${inv.num}</h1>
    <p>Client: ${inv.client}</p>
    <p>Date: ${inv.date}</p>
    <p>Due: ${inv.due}</p>
    <p>Subtotal: ${inv.subtotal.toFixed(2)}</p>
    <p>Tax: ${inv.tax.toFixed(2)}</p>
    <p>Total: ${inv.total.toFixed(2)}</p>
    <script>window.print();<\/script>
  </body></html>`);
}
</script>
</body>
</html>
